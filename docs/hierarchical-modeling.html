<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Hierarchical Modeling | Bayesian Finance: Modeling Earnings for S&amp;P 500 Companies</title>
  <meta name="description" content="Bayesian Statistics Capstone Project" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Hierarchical Modeling | Bayesian Finance: Modeling Earnings for S&amp;P 500 Companies" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Bayesian Statistics Capstone Project" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Hierarchical Modeling | Bayesian Finance: Modeling Earnings for S&amp;P 500 Companies" />
  
  <meta name="twitter:description" content="Bayesian Statistics Capstone Project" />
  

<meta name="author" content="Nicholas Di, Nolan Meyer, Duc Ngo" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data.html"/>
<link rel="next" href="bayes-forecast.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="lib/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="lib/css/style.css" type="text/css" />
<link rel="stylesheet" href="lib/css/lesson.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">STAT 454 Capstone</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data.html"><a href="data.html"><i class="fa fa-check"></i><b>2</b> Data</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data.html"><a href="data.html#data-source"><i class="fa fa-check"></i><b>2.1</b> Data Source</a></li>
<li class="chapter" data-level="2.2" data-path="data.html"><a href="data.html#variables"><i class="fa fa-check"></i><b>2.2</b> Variables</a></li>
<li class="chapter" data-level="2.3" data-path="data.html"><a href="data.html#data-cleaning"><i class="fa fa-check"></i><b>2.3</b> Data Cleaning</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="data.html"><a href="data.html#data-pre-processing"><i class="fa fa-check"></i><b>2.3.1</b> Data Pre-Processing</a></li>
<li class="chapter" data-level="2.3.2" data-path="data.html"><a href="data.html#graphing-outliers"><i class="fa fa-check"></i><b>2.3.2</b> Graphing Outliers</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="data.html"><a href="data.html#initial-explorations"><i class="fa fa-check"></i><b>2.4</b> Initial Explorations</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html"><i class="fa fa-check"></i><b>3</b> Hierarchical Modeling</a>
<ul>
<li class="chapter" data-level="3.1" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#set-up"><i class="fa fa-check"></i><b>3.1</b> Set Up</a></li>
<li class="chapter" data-level="3.2" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#model-1-hierarchical-w-different-intercepts"><i class="fa fa-check"></i><b>3.2</b> Model 1: Hierarchical w/ Different Intercepts</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#model-structure"><i class="fa fa-check"></i><b>3.2.1</b> Model Structure</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#model-2-hierarchical-w-different-slopes-and-intercepts"><i class="fa fa-check"></i><b>3.3</b> Model 2: Hierarchical w/ Different Slopes and Intercepts</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#model-structure-1"><i class="fa fa-check"></i><b>3.3.1</b> Model Structure</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#model-evaluations"><i class="fa fa-check"></i><b>3.4</b> Model Evaluations</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#is-this-the-right-model"><i class="fa fa-check"></i><b>3.4.1</b> Is this the right model?</a></li>
<li class="chapter" data-level="3.4.2" data-path="hierarchical-modeling.html"><a href="hierarchical-modeling.html#how-accurate-are-the-models"><i class="fa fa-check"></i><b>3.4.2</b> How Accurate are the models?</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="bayes-forecast.html"><a href="bayes-forecast.html"><i class="fa fa-check"></i><b>4</b> Bayes Forecast</a>
<ul>
<li class="chapter" data-level="4.1" data-path="bayes-forecast.html"><a href="bayes-forecast.html#model-parameters"><i class="fa fa-check"></i><b>4.1</b> Model Parameters</a></li>
<li class="chapter" data-level="4.2" data-path="bayes-forecast.html"><a href="bayes-forecast.html#modeling"><i class="fa fa-check"></i><b>4.2</b> Modeling</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="finalmodel.html"><a href="finalmodel.html"><i class="fa fa-check"></i><b>5</b> Final Model</a></li>
<li class="chapter" data-level="6" data-path="reflection.html"><a href="reflection.html"><i class="fa fa-check"></i><b>6</b> Reflection</a>
<ul>
<li class="chapter" data-level="6.1" data-path="reflection.html"><a href="reflection.html#next-steps"><i class="fa fa-check"></i><b>6.1</b> Next Steps</a></li>
<li class="chapter" data-level="6.2" data-path="reflection.html"><a href="reflection.html#acknowledgements"><i class="fa fa-check"></i><b>6.2</b> Acknowledgements</a></li>
<li class="chapter" data-level="6.3" data-path="reflection.html"><a href="reflection.html#citations"><i class="fa fa-check"></i><b>6.3</b> Citations</a></li>
<li class="chapter" data-level="6.4" data-path="reflection.html"><a href="reflection.html#code-appendix"><i class="fa fa-check"></i><b>6.4</b> Code Appendix</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Bayesian Finance: Modeling Earnings for S&amp;P 500 Companies</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hierarchical-modeling" class="section level1" number="3">
<h1><span class="header-section-number">Chapter 3</span> Hierarchical Modeling</h1>
<div id="set-up" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Set Up</h2>
<p>Since we have time-series data, we created a testing set by sub-setting each company’s 2nd to latest year. We will predict earnings next year with the testing set and compare it with the actual values to help determine model accuracy.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="hierarchical-modeling.html#cb8-1" aria-hidden="true" tabindex="-1"></a>testing <span class="ot">&lt;-</span> data_elimatedO <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="hierarchical-modeling.html#cb8-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(COMPANY) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="hierarchical-modeling.html#cb8-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(<span class="fu">row_number</span>()<span class="sc">==</span><span class="dv">1</span>)</span>
<span id="cb8-4"><a href="hierarchical-modeling.html#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="hierarchical-modeling.html#cb8-5" aria-hidden="true" tabindex="-1"></a>training <span class="ot">&lt;-</span> <span class="fu">anti_join</span>(data_elimatedO, testing)</span></code></pre></div>
</div>
<div id="model-1-hierarchical-w-different-intercepts" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Model 1: Hierarchical w/ Different Intercepts</h2>
<div id="model-structure" class="section level3" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Model Structure</h3>
<p>Now, we will move on to utilizing the structure of our data, where we have consecutive observations for each company for several years. We start with a model with varying intercepts. Note: we fit each model using training data for evaluation purposes.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="hierarchical-modeling.html#cb9-1" aria-hidden="true" tabindex="-1"></a>Diff_inter_train <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;Diff_inter_train_nick.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="hierarchical-modeling.html#cb10-1" aria-hidden="true" tabindex="-1"></a>model_diff_inter_train_data <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="hierarchical-modeling.html#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;Earnings_next_year_Scaled&quot;</span>,<span class="st">&quot;EARNINGS_Scaled&quot;</span>,<span class="st">&quot;EARNINGS_1_YEAR_AGO&quot;</span>,<span class="st">&quot;COMPANY&quot;</span>,<span class="st">&quot;Sector&quot;</span>)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb10-3"><a href="hierarchical-modeling.html#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="hierarchical-modeling.html#cb10-4" aria-hidden="true" tabindex="-1"></a>model_diff_inter_train <span class="ot">&lt;-</span> <span class="fu">stan_glmer</span>(</span>
<span id="cb10-5"><a href="hierarchical-modeling.html#cb10-5" aria-hidden="true" tabindex="-1"></a>  Earnings_next_year_Scaled <span class="sc">~</span> EARNINGS_Scaled <span class="sc">+</span> EARNINGS_1_YEAR_AGO  <span class="sc">+</span> Sector <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> COMPANY) , <span class="at">data =</span> model_diff_inter_train_data, </span>
<span id="cb10-6"><a href="hierarchical-modeling.html#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb10-7"><a href="hierarchical-modeling.html#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">5000</span><span class="sc">*</span><span class="dv">2</span>, <span class="at">seed =</span> <span class="dv">84735</span>, </span>
<span id="cb10-8"><a href="hierarchical-modeling.html#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior_PD =</span> <span class="cn">FALSE</span>, <span class="at">refresh =</span> <span class="dv">0</span>)</span>
<span id="cb10-9"><a href="hierarchical-modeling.html#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="hierarchical-modeling.html#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(model_diff_inter_train, <span class="st">&quot;Diff_Inter_train_nick.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="hierarchical-modeling.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(Diff_inter_train)</span></code></pre></div>
<p>Below is the notation for the differing intercepts model:</p>
<p><span class="math display">\[\begin{split}
\text{Relationship within company:} &amp; \\
Y_{ij} | \beta_{0j}, \beta_1, \sigma_y 
&amp; \sim N(\mu_{ij}, \sigma_y^2) \;\; \text{ where } \mu_{ij} = \beta_{0j} + \beta_1 X_{ij} + \beta_2 X_{ij} + \beta_3 X_{ij}...\\
&amp; \\
\text{Variability between companies:} &amp; \\
\beta_{0j} &amp; \stackrel{ind}{\sim} N(\beta_0, \sigma_0^2) \\
&amp; \\
\text{Prior information on Globals with Adjusted Prior} &amp; \\
\beta_{0c} &amp; \sim N(0.59, 1.5^2) \\
\beta_1 &amp; \sim N(0, 1.74^2) \\
\beta_2 &amp; \sim N(0, 1.60^2) \\
\beta_3 &amp; \sim N(0, 4.60^2) \\
.\\
.\\
.\\
\sigma_y  &amp; \sim \text{Exp}(1.6) \\
\sigma_0  &amp; \sim \text{Exp}(1) \\
\end{split}\]</span></p>
</div>
</div>
<div id="model-2-hierarchical-w-different-slopes-and-intercepts" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Model 2: Hierarchical w/ Different Slopes and Intercepts</h2>
<div id="model-structure-1" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Model Structure</h3>
<p>In addition to having a hierarchical regression with different intercepts, we decided to add a model with different intercepts and slopes.</p>
<p><strong>Rational behind different slopes:</strong></p>
<p>Below we graph 4 random companies, we can see that earnings in the current year impacts earnings next year differently among different companies.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="hierarchical-modeling.html#cb12-1" aria-hidden="true" tabindex="-1"></a>eliminated <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="hierarchical-modeling.html#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(COMPANY <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;AAL&quot;</span>,<span class="st">&quot;CVS&quot;</span>,<span class="st">&quot;DAL&quot;</span>,<span class="st">&quot;WAB&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="hierarchical-modeling.html#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(., <span class="fu">aes</span>(<span class="at">x =</span> EARNINGS_Scaled, <span class="at">y =</span> Earnings_next_year_Scaled)) <span class="sc">+</span> </span>
<span id="cb12-4"><a href="hierarchical-modeling.html#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb12-5"><a href="hierarchical-modeling.html#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb12-6"><a href="hierarchical-modeling.html#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(<span class="sc">~</span> COMPANY)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>To get a better idea of the varying slopes, I graph 50 random companies together.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="hierarchical-modeling.html#cb13-1" aria-hidden="true" tabindex="-1"></a>vector <span class="ot">&lt;-</span> eliminated<span class="sc">$</span>COMPANY</span>
<span id="cb13-2"><a href="hierarchical-modeling.html#cb13-2" aria-hidden="true" tabindex="-1"></a>vector <span class="ot">&lt;-</span> <span class="fu">sample_n</span>(<span class="fu">as.data.frame</span>(vector), <span class="dv">50</span>)</span>
<span id="cb13-3"><a href="hierarchical-modeling.html#cb13-3" aria-hidden="true" tabindex="-1"></a>vector <span class="ot">&lt;-</span> <span class="fu">as.list</span>(vector)</span>
<span id="cb13-4"><a href="hierarchical-modeling.html#cb13-4" aria-hidden="true" tabindex="-1"></a>eliminated <span class="sc">%&gt;%</span> </span>
<span id="cb13-5"><a href="hierarchical-modeling.html#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(COMPANY <span class="sc">%in%</span> vector<span class="sc">$</span>vector) <span class="sc">%&gt;%</span> </span>
<span id="cb13-6"><a href="hierarchical-modeling.html#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>EARNINGS_Scaled, <span class="at">y=</span> Earnings_next_year_Scaled, <span class="at">group =</span> COMPANY))<span class="sc">+</span></span>
<span id="cb13-7"><a href="hierarchical-modeling.html#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se=</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="fl">0.5</span>)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>We believe it makes sense to replace the global earnings coefficientwith a company specific earnings coefficient.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="hierarchical-modeling.html#cb14-1" aria-hidden="true" tabindex="-1"></a>Diff_inter_slope_train <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;Diff_inter_slope_train_nick.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="hierarchical-modeling.html#cb15-1" aria-hidden="true" tabindex="-1"></a>model_diff_inter_slope_train_data <span class="ot">&lt;-</span> training <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="hierarchical-modeling.html#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;Earnings_next_year_Scaled&quot;</span>,<span class="st">&quot;Sector&quot;</span>,<span class="st">&quot;COMPANY&quot;</span>,<span class="st">&quot;EARNINGS_Scaled&quot;</span>,<span class="st">&quot;EARNINGS_1_YEAR_AGO&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="hierarchical-modeling.html#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb15-4"><a href="hierarchical-modeling.html#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="hierarchical-modeling.html#cb15-5" aria-hidden="true" tabindex="-1"></a>diff_slope_inter_model_train <span class="ot">&lt;-</span> <span class="fu">stan_glmer</span>(</span>
<span id="cb15-6"><a href="hierarchical-modeling.html#cb15-6" aria-hidden="true" tabindex="-1"></a>  Earnings_next_year_Scaled <span class="sc">~</span> EARNINGS_Scaled <span class="sc">+</span> EARNINGS_1_YEAR_AGO <span class="sc">+</span> (EARNINGS_Scaled <span class="sc">|</span> COMPANY) <span class="sc">+</span> Sector, <span class="at">data =</span> model_diff_inter_slope_train_data, </span>
<span id="cb15-7"><a href="hierarchical-modeling.html#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> gaussian,</span>
<span id="cb15-8"><a href="hierarchical-modeling.html#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">iter =</span> <span class="dv">5000</span><span class="sc">*</span><span class="dv">2</span>, <span class="at">seed =</span> <span class="dv">84735</span>, </span>
<span id="cb15-9"><a href="hierarchical-modeling.html#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior_PD =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-10"><a href="hierarchical-modeling.html#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(diff_slope_inter_model_train, <span class="st">&quot;Diff_inter_slope_train_nick.rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="hierarchical-modeling.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prior_summary</span>(Diff_inter_slope_train)</span></code></pre></div>
<p>Different intercepts &amp; slopes model notation:</p>
<p><span class="math display">\[\begin{split}
Y_{ij} | \beta_{0j}, \beta_{1j}, \sigma_y &amp; \sim N(\mu_{ij}, \sigma_y^2) \;\; \text{ where } \; \mu_{ij} = \beta_{0j} + \beta_{1j} X_{ij} + \beta_{2} X_{ij}  + \beta_{3} X_{ij}...\\
&amp; \\
\beta_{0j} &amp; \sim N(\beta_0, \sigma_0^2) \\
\beta_{1j} &amp; \sim N(\beta_1, \sigma_1^2) \\
&amp; \\
\beta_{0c} &amp; \sim N(0.59, 1.5^2)  \\
\beta_1 &amp; \sim N(0, 1.74^2) \\
.\\
.\\
.\\
\sigma_y &amp; \sim \text{Exp}(1.6)    \\
\sigma_0, \sigma_1, ... &amp; \sim \text{(something a bit complicated)}. \\
\end{split}\]</span></p>
</div>
</div>
<div id="model-evaluations" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Model Evaluations</h2>
<div id="is-this-the-right-model" class="section level3" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Is this the right model?</h3>
<p>Next we plot the posterior distributions and compare to the actual values observed in the data set.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="hierarchical-modeling.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(Diff_inter_train) </span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="hierarchical-modeling.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">pp_check</span>(Diff_inter_slope_train)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-27-2.png" width="672" /></p>
<p>Again, several company earnings’ on the right seem to be causing model fitness difficulties. Both models run into this problem.</p>
<p>There seems to be little difference between the two models in terms of fitting the structure of earnings next year. We will now dive into predicting the accuracy of the models.</p>
</div>
<div id="how-accurate-are-the-models" class="section level3" number="3.4.2">
<h3><span class="header-section-number">3.4.2</span> How Accurate are the models?</h3>
<p><strong>Model 1 - Specific Examples with companies:</strong></p>
<p>Below, we compare our predictions for American Airlines. We plot 750 random values predicted from our predictions (out of 20,000). As we can see below our predictions range cover the actual value of earnings for 2020 fiscal year for both models.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="hierarchical-modeling.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">84732</span>)</span>
<span id="cb19-2"><a href="hierarchical-modeling.html#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict_model</span>(<span class="st">&quot;AAL&quot;</span>, Diff_inter_train)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="hierarchical-modeling.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mcmc_areas(predict_next_year, prob = 0.8) +</span></span>
<span id="cb20-2"><a href="hierarchical-modeling.html#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot2::scale_y_discrete(labels = c(`test_comp`)) + geom_vline(xintercept = actual, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) </span></span>
<span id="cb20-3"><a href="hierarchical-modeling.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">#Need Help Because X scale is different</span></span></code></pre></div>
<p><strong>Model 2 - Specific Examples with companies:</strong></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="hierarchical-modeling.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">84732</span>)</span>
<span id="cb21-2"><a href="hierarchical-modeling.html#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">predict_model</span>(<span class="st">&quot;AAL&quot;</span>, Diff_inter_slope_train)</span></code></pre></div>
<p><img src="series_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="hierarchical-modeling.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># mcmc_areas(predict_next_year, prob = 0.8) +</span></span>
<span id="cb22-2"><a href="hierarchical-modeling.html#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   ggplot2::scale_y_discrete(labels = c(`test_comp`)) + geom_vline(xintercept = actual, linetype = &quot;dashed&quot;, colour = &quot;red&quot;) </span></span></code></pre></div>
<p>The predictions for the second model seem to be slightly better as more posterior predictive points are near the actual value for “2020”.</p>
<p><strong>Evaluating Metrics</strong></p>
<p>Different Intercepts Model:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="hierarchical-modeling.html#cb23-1" aria-hidden="true" tabindex="-1"></a>Diff_inter_metrics</span></code></pre></div>
<pre><code>##         MAE  Within95  Within50
## 1 0.3620034 0.7543103 0.4181034</code></pre>
<p>Different Intercepts &amp; Slopes Model:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="hierarchical-modeling.html#cb25-1" aria-hidden="true" tabindex="-1"></a>Diff_inter_slope_metrics</span></code></pre></div>
<pre><code>##         MAE  Within95  Within50
## 1 0.2781092 0.7931034 0.4935345</code></pre>
<p>We can see that our model with varying intercepts and slopes (model 2) preforms slightly better. Where our average median posterior prediction is off by 0.28 billion as opposed to 0.362 billion when we only have differing intercepts. Furthermore, our 95 and 50 interval values are both better in the model with different intercept and slope.</p>
<p><strong>Shrinkage </strong></p>
<p>Since we modeled based off different companies having different intercepts, it is worthwhile to checkout how the company baselines shrunk compared to each other and between the two different models.</p>
<p>Model 1 Shrinkage:</p>
<p><img src="series_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<p>Model 2 Shrinkage:</p>
<p><img src="series_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<p><strong>Global Standard Deviation Parameters: NOT COMPLETED ADFASGARGERGEARG</strong></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="hierarchical-modeling.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_2, <span class="at">effects =</span> <span class="st">&quot;ran_pars&quot;</span>)</span>
<span id="cb27-2"><a href="hierarchical-modeling.html#cb27-2" aria-hidden="true" tabindex="-1"></a>(<span class="fl">0.4512</span><span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>((<span class="fl">0.4512</span><span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> (<span class="fl">0.5519447</span><span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb27-3"><a href="hierarchical-modeling.html#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="hierarchical-modeling.html#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(model_3, <span class="at">effects =</span> <span class="st">&quot;ran_pars&quot;</span>)</span>
<span id="cb27-5"><a href="hierarchical-modeling.html#cb27-5" aria-hidden="true" tabindex="-1"></a>(<span class="fl">0.4294</span><span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span>((<span class="fl">0.4294</span><span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> (<span class="fl">0.5450631</span>)<span class="sc">^</span><span class="dv">2</span>)</span></code></pre></div>
<p>In model 2, about 40.06% of the variance can be explained between companies. In model 3, about 38.29% of the variance can be explained between companies. This means that when including sectors and lagged variables, more variable shrinkage occurred. Unfortunately this shrinkage is not as evident in the plotted graphs above. Model 3’s baseline intercepts differ among each other slightly less than model 2’s.</p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="bayes-forecast.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
